<!doctype html><title>Weirdness of S3 List Permission</title><link rel="shortcut icon" href=https://sak96.github.io/theme/images/favicon.svg><meta content=width=device-width,initial-scale=1.0 name=viewport><meta charset=UTF-8><link href=https://sak96.github.io/feeds/all.atom.xml rel=alternate title=sak96-blog type=application/atom+xml><link href=https://sak96.github.io/theme/syntax/pygment.css rel=stylesheet><style>*{box-sizing:border-box}:root{--bg:#1d2021;--fg:#d4be98;--gray:#928374;--blue:#7daea3;--green:#a9b665;--red:#ea6962}[data-theme=light]{--bg:#f9f5d7;--fg:#654735;--gray:#928374;--blue:#45707a;--green:#6c782e;--red:#c14a4a}table,th,td{border:1px solid var(--fg);border-collapse:collapse;padding:10px}.codehilitetable{border:2px solid var(--blue);border-collapse:collapse;border-radius:4px;padding:0;font-family:monospace;display:block;overflow-x:auto}.codehilite{margin:0 1em}.linenos{text-align:right;border:0;border-right:2px solid var(--blue);-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-khtml-user-select:none;padding:0 .5em}.code{border:0}body{background-color:var(--bg);color:var(--fg)}a{color:var(--blue);text-decoration:none}h1,h2,h3,h4,h5,h6{color:var(--green)}small{color:var(--gray)}.navbar{border-bottom:1px solid var(--green)}.navbar div{display:inline-block}.nav-end{position:absolute;right:.5rem}.navbar a{padding:.5rem 0}.navbar a:before{content:"["}.navbar a:after{content:"]"}#theme{cursor:pointer}[data-theme=light] #theme:before{content:"[ðŸŒš:"}#theme:before{content:"[ðŸŒž:"}#navbar-toggler{display:none}.content{width:80%;max-width:50rem;margin:auto}article em,article strong{color:var(--red)}.not-found,.coming-soon{text-align:center;width:100%;display:block}.item{border-top:1px dashed var(--red);color:var(--fg);margin:.5rem 0;padding:1rem;display:block}.item>:first-child{margin-top:0}.img-fluid{width:100%}.paginator{justify-content:space-between;margin:.5rem;display:flex}.footer,.tags{justify-content:center;margin:.5rem;display:flex}.disabled{pointer-events:none;color:var(--gray)}@media only screen and (width<=500px){.navbar{border:none}.nav-header{border-bottom:.025rem solid var(--green)}.navbar div{display:block;position:static}#navbar-toggler{background-color:inherit;color:inherit;border:none;display:inline;position:absolute;right:1rem;transform:rotate(90deg)}.navbar a:after,.navbar a:before{content:""}.navbar a{border-bottom:.025rem solid var(--green);display:none}.nav-header a{border:none;display:inline-block}.navbar a.show{display:block}.content{width:100%}.footer{display:inline-block}.paginator span{display:none}[data-theme=light] #theme:before{content:"ðŸŒš:"}#theme:before{content:"ðŸŒž:"}}</style><body><div class=navbar><div class=nav-header><a href=https://sak96.github.io/index.html>sak96-blog</a><a id=navbar-toggler>|||</a></div><div class=nav-start><a href=https://sak96.github.io/authors.html>Authors</a><a href=https://sak96.github.io/categories.html>Categories</a><a href=https://sak96.github.io/tags.html>Tags</a></div><div class=nav-end><a href=https://sak96.github.io/feeds/all.atom.xml>Atom</a><a id=theme>Theme</a></div></div><script>document.querySelector(`#navbar-toggler`).onclick=(a=>{document.querySelectorAll(`.nav-start a,.nav-end a`).forEach(a=>a.classList.toggle(`show`))});{let d=`data-theme`,e=`dark`,c=`light`,b=`theme`;let a=localStorage.getItem(b);if(a===c||window.matchMedia(`(prefers-color-scheme: light)`).matches){document.documentElement.setAttribute(d,c);localStorage.setItem(b,c)}else{document.documentElement.setAttribute(d,e);localStorage.setItem(b,e)}}document.querySelector(`#theme`).onclick=(a=>{let b=`data-theme`,d=`light`,c=`theme`;if(document.documentElement.getAttribute(b)){document.documentElement.setAttribute(b,``);localStorage.setItem(c,`dark`)}else{document.documentElement.setAttribute(b,d);localStorage.setItem(c,d)}})</script><div class=content><div><h1>Weirdness of S3 List Permission</h1><h5><p>Understand Weirdness in S3 List permission model.</h5><h5>Read time: 5 min</h5><small>Written on June 20, 2021</small></div><div><article><h2>S3 is flat</h2><p>S3 is one of the file storage service available in the "Cloud". The common way the file are stored is using folder hierarchies. But S3 does not use hierarchies to store files. Instead all files are stored in flat structure. There are no folders, only key value pairs of path and content of file.<p>Most interface designs try to maintain consistency with folder hierarchies. This is done by using <code>/</code> as delimiter for folder names. This allows user to carry on his life, as if, he was using folder hierarchies. But interestingly, forgetting that S3 is flat may not be entirely good.<h2>S3 List Operation</h2><p>Listing file in normal folder hierarchy is trivial to imagine. List all the file and folder children of given folder.<p>But in case of flat hierarchy it becomes interesting. There are no folder to list, so what constitutes a list operation? The ideal answer would be, to map to what would have happened it were folder hierarchy.<p>So List operation would show all files/folder starting with certain prefix. Where files would start with the prefix and does not contain a '/'. Where as folders would start with the prefix and end with a '/'. This seems to match what we would have expected from folder hierarchy.<h2>S3 List Permission</h2><p>Consider a case where you are storing home directories of user to s3. You would want the user to only able to read,write and <strong>list</strong> his own home. Also the home folder name is same as user name.<p>If you googlefu is strong enough you may end up <a href=https://web.archive.org/web/20201112042023/https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_examples_s3_home-directory-console.html>here</a>. I prefer duckduckgo so, I typed <code>!aws IAM users S3 home</code> and picked the first result. <code>!aws</code> searches for aws docs, this is bang search from duckduckgo, more <a href=https://duckduckgo.com/bang>here</a>.<p>You might feel that computer security gods and smiling on you. And yes, they are! But not in the way you would hope, not for you happiness. They are, in fact, laughing (not just smiling) at you as you walk into the pit.<p>This article is interested in list operation, So, let ignore all other operation. Below is the json permission for managing list operation from <a href=https://web.archive.org/web/20201112042023/https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_examples_s3_home-directory-console.html>here</a>.<div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span></pre></div><td class=code><div><pre><span></span><span class=p>{</span>
<span class=w>  </span><span class=nt>"Effect"</span><span class=p>:</span><span class=w> </span><span class=s2>"Allow"</span><span class=p>,</span>
<span class=w>  </span><span class=nt>"Action"</span><span class=p>:</span><span class=w> </span><span class=s2>"s3:ListBucket"</span><span class=p>,</span>
<span class=w>  </span><span class=nt>"Resource"</span><span class=p>:</span><span class=w> </span><span class=s2>"arn:aws:s3:::bucket-name"</span><span class=p>,</span>
<span class=w>  </span><span class=nt>"Condition"</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=nt>"StringLike"</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=nt>"s3:prefix"</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>""</span><span class=p>,</span><span class=w> </span><span class=s2>"home/"</span><span class=p>,</span><span class=w> </span><span class=s2>"home/${aws:username}/*"</span><span class=p>]</span>
<span class=w>    </span><span class=p>}</span>
<span class=w>  </span><span class=p>}</span>
<span class=p>}</span>
</pre></div></table></div><p>So the recommended way to restrict list operation is to use <code>s3:prefix</code> condition. This means restriction is entirely based on prefixes.<p>Now let us analyze each prefix one by one.<table><thead><tr><th>prefix<th>use<tbody><tr><td>""<td>to list root directory<tr><td>"home/"<td>to list all directory in home<tr><td aws:username=aws:username>"home/$<td>list any thing is user's own home</table><p>Note: <code>${aws:username}</code> is to map every user's home directory name to user name.<p>Now let go back to what exactly list does. <strong>List operation would show all files/folder starting with certain prefix</strong>. So everything is fine, correct ? There should be no issue with this.<p>No, Interface just hides flat structure of the storage. But we also have recursive listing in folder structure. Imagine, What happens if you use the same here, but on <strong>prefix</strong> ? In particular with <strong>home/</strong> or <strong>""</strong> ?<p>You should be able to see all file beginning with "home/" or "". This means you should also be able to see "home/some_other_user/..." in the list. This is exactly what happens, meaning you can see all files in other's home directory. This may not be a issue as they cannot still read or write the files.<h2>My Story with List Permission</h2><p>The above issue was something I had already in my mind when I was framing the policy. We decided to go with following list permission in the policy.<div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span></pre></div><td class=code><div><pre><span></span><span class=p>{</span>
<span class=w>  </span><span class=nt>"Effect"</span><span class=p>:</span><span class=w> </span><span class=s2>"Allow"</span><span class=p>,</span>
<span class=w>  </span><span class=nt>"Action"</span><span class=p>:</span><span class=w> </span><span class=s2>"s3:ListBucket"</span><span class=p>,</span>
<span class=w>  </span><span class=nt>"Resource"</span><span class=p>:</span><span class=w> </span><span class=s2>"arn:aws:s3:::bucket-name"</span><span class=p>,</span>
<span class=w>  </span><span class=nt>"Condition"</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=nt>"StringLike"</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=nt>"s3:prefix"</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>"home/${aws:username}/*"</span><span class=p>]</span>
<span class=w>    </span><span class=p>}</span>
<span class=w>  </span><span class=p>}</span>
<span class=p>}</span>
</pre></div></table></div><p>When the policy was used and there were issue, Some of list operation failed. Many user were using <code>home/${aws:username}</code>, without trailing <code>/</code>. This means a lot changes had to be done to comply with this policy. So we decided to allow the path without trailing <code>/</code>.<div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span></pre></div><td class=code><div><pre><span></span><span class=p>{</span>
<span class=w>  </span><span class=nt>"Effect"</span><span class=p>:</span><span class=w> </span><span class=s2>"Allow"</span><span class=p>,</span>
<span class=w>  </span><span class=nt>"Action"</span><span class=p>:</span><span class=w> </span><span class=s2>"s3:ListBucket"</span><span class=p>,</span>
<span class=w>  </span><span class=nt>"Resource"</span><span class=p>:</span><span class=w> </span><span class=s2>"arn:aws:s3:::bucket-name"</span><span class=p>,</span>
<span class=w>  </span><span class=nt>"Condition"</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=nt>"StringLike"</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=nt>"s3:prefix"</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>"home/${aws:username}"</span><span class=p>,</span><span class=w> </span><span class=s2>"home/${aws:username}/*"</span><span class=p>]</span>
<span class=w>    </span><span class=p>}</span>
<span class=w>  </span><span class=p>}</span>
<span class=p>}</span>
</pre></div></table></div><p>Seems ok, there should be no issues, right? It did seem to work well, when we tested again. All scripts worked as expected. But, it had a serious security draw back.<p>Just imagine if you had two user <code>user</code> and <code>user_with_user_prefix</code>. And now what happens if <code>user</code> list for his home without <code>/</code>. And yeah user can do it recursively. This list <code>user_with_user_prefix</code>'s home contents as well.<p>Note, This might not be problem if you have constant length strings for username. For example in this <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_examples_s3_cognito-bucket.html>aws docs</a>, similar policy is shown. By my understanding, these <code>${cognito-identity.amazonaws.com:sub}</code> are all same length. Which means there cannot be sub-string of one another. In other words, sanitize user input, even user names.<h2>Conclusion</h2><ol><li>Never hurry, especially a security related activity. It's ok to be slow.<li>Some times, Concentrate concepts may be better then abstract interface.<li>Repeat, Thinking in terms of flat structure <code>></code> folder hierarchy interface.<li>Sanitize user input may be a good idea.<li>Use <a href=https://duckduckgo.com/bang>bang</a> to search faster.</ol></article></div><div class=tags><span>Post Tags:</span><a href=tag/story.html>Â #story,</a><a href=tag/s3.html>Â #s3,</a><a href=tag/security.html>Â #security</a></div><hr class=my-3><div id=comments></div><script>var PopulateComment=(a=>{let e=`div`,f=`a`,g=`item`;commentsBlock=document.getElementById(`comments`);let b=document.createElement(e);b.innerText=`Comments`;commentsBlock.append(b);let c=document.createElement(e);commentsBlock.append(c);a.forEach(a=>{let b=document.createElement(`span`);b.innerText=a.user.login;updateTime=document.createElement(`small`);updateTime.innerText=`(`+ a.updated_at+ `)`;commentBody=document.createElement(e);commentBody.innerText=a.body;lineBreak=document.createElement(`br`);commentBox=document.createElement(f);commentBox.classList.add(g);commentBox.append(b);commentBox.append(updateTime);commentBox.append(lineBreak);commentBox.append(commentBody);commentBox.href=a.html_url;c.append(commentBox)});let d=document.createElement(f);d.classList.add(g);d.href=issueUrl;d.innerText=`Have some comments? Add comment ...`;c.append(d)});let commentUrl=`https://api.github.com/repos/sak96/sak96.github.io/issues/11/comments`;let issueUrl=`https://github.com/sak96/sak96.github.io/issues/11`;var xhr=new XMLHttpRequest();xhr.open(`GET`,commentUrl,!0);xhr.responseType=`json`;xhr.onload=(()=>{var a=xhr.status;if(a===200){console.log(PopulateComment(xhr.response))}else{console.log(xhr.response)}});xhr.send()</script><script src=https://unpkg.com/mermaid@latest/dist/mermaid.min.js></script><hr><div class=footer><span>Powered by:</span><a href=http://getpelican.com/>Pelican,</a><a href=https://github.com/pygments/pygments>Pygments,</a><a href=https://github.com/morhetz/gruvbox-contrib>Gruvbox</a></div></div>