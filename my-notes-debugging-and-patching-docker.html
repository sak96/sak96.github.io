<!doctype html><title>My Notes: Debugging And Patching Docker</title><link rel="shortcut icon" href=https://sak96.github.io/theme/images/favicon.svg><meta content=width=device-width,initial-scale=1.0 name=viewport><meta charset=UTF-8><link href=https://sak96.github.io/feeds/all.atom.xml rel=alternate title=sak96-blog type=application/atom+xml><link href=https://sak96.github.io/theme/syntax/pygment.css rel=stylesheet><style>*{box-sizing:border-box}:root{--bg:#1d2021;--fg:#d4be98;--gray:#928374;--blue:#7daea3;--green:#a9b665;--red:#ea6962}[data-theme=light]{--bg:#f9f5d7;--fg:#654735;--gray:#928374;--blue:#45707a;--green:#6c782e;--red:#c14a4a}table,th,td{border:1px solid var(--fg);border-collapse:collapse;padding:10px}.codehilitetable{border:2px solid var(--blue);border-collapse:collapse;border-radius:4px;padding:0;font-family:monospace;display:block;overflow-x:auto}.codehilite{margin:0 1em}.linenos{text-align:right;border:0;border-right:2px solid var(--blue);-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-khtml-user-select:none;padding:0 .5em}.code{border:0}body{background-color:var(--bg);color:var(--fg)}a{color:var(--blue);text-decoration:none}h1,h2,h3,h4,h5,h6{color:var(--green)}small{color:var(--gray)}.navbar{border-bottom:1px solid var(--green)}.navbar div{display:inline-block}.nav-end{position:absolute;right:.5rem}.navbar a{padding:.5rem 0}.navbar a:before{content:"["}.navbar a:after{content:"]"}#theme{cursor:pointer}[data-theme=light] #theme:before{content:"[ðŸŒš:"}#theme:before{content:"[ðŸŒž:"}#navbar-toggler{display:none}.content{width:80%;max-width:50rem;margin:auto}article em,article strong{color:var(--red)}.not-found,.coming-soon{text-align:center;width:100%;display:block}.item{border-top:1px dashed var(--red);color:var(--fg);margin:.5rem 0;padding:1rem;display:block}.item>:first-child{margin-top:0}.img-fluid{width:100%}.paginator{justify-content:space-between;margin:.5rem;display:flex}.footer,.tags{justify-content:center;margin:.5rem;display:flex}.disabled{pointer-events:none;color:var(--gray)}@media only screen and (width<=500px){.navbar{border:none}.nav-header{border-bottom:.025rem solid var(--green)}.navbar div{display:block;position:static}#navbar-toggler{background-color:inherit;color:inherit;border:none;display:inline;position:absolute;right:1rem;transform:rotate(90deg)}.navbar a:after,.navbar a:before{content:""}.navbar a{border-bottom:.025rem solid var(--green);display:none}.nav-header a{border:none;display:inline-block}.navbar a.show{display:block}.content{width:100%}.footer{display:inline-block}.paginator span{display:none}[data-theme=light] #theme:before{content:"ðŸŒš:"}#theme:before{content:"ðŸŒž:"}}</style><body><div class=navbar><div class=nav-header><a href=https://sak96.github.io/index.html>sak96-blog</a><a id=navbar-toggler>|||</a></div><div class=nav-start><a href=https://sak96.github.io/authors.html>Authors</a><a href=https://sak96.github.io/categories.html>Categories</a><a href=https://sak96.github.io/tags.html>Tags</a></div><div class=nav-end><a href=https://sak96.github.io/feeds/all.atom.xml>Atom</a><a id=theme>Theme</a></div></div><script>document.querySelector(`#navbar-toggler`).onclick=(a=>{document.querySelectorAll(`.nav-start a,.nav-end a`).forEach(a=>a.classList.toggle(`show`))});{let d=`data-theme`,e=`dark`,c=`light`,b=`theme`;let a=localStorage.getItem(b);if(a===c||window.matchMedia(`(prefers-color-scheme: light)`).matches){document.documentElement.setAttribute(d,c);localStorage.setItem(b,c)}else{document.documentElement.setAttribute(d,e);localStorage.setItem(b,e)}}document.querySelector(`#theme`).onclick=(a=>{let b=`data-theme`,d=`light`,c=`theme`;if(document.documentElement.getAttribute(b)){document.documentElement.setAttribute(b,``);localStorage.setItem(c,`dark`)}else{document.documentElement.setAttribute(b,d);localStorage.setItem(c,d)}})</script><div class=content><div><h1>My Notes: Debugging And Patching Docker</h1><h5><p>This article provide some notes for debugging and patching docker.</h5><h5>Read time: 5 min</h5><small>Written on February 29, 2020</small></div><div><article><p>Containerization of software and services allows easy deployment, portability and many other benefits. Docker is one of wide-spread adopted technology used for containerization. I use docker while on work. There are many guide and articles about using and debugging docker. Here is my guide for debugging and patching docker. And link to <a href=#Resources>resources</a>.<h1>Terminologies.</h1><ul><li>Docker: software used for containerization.<li>Image: snapshot of container.<li>Container: running instance of image.</ul><h1>Information Gathering.</h1><p>The first stage of any debugging session is gathering information. Skipping this steps may lead to spending hours on issue which may have been resolved in minutes.<h2>Container inspection.</h2><ul><li>Get all running container.</ul><div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span><span class=gp>user@host$ </span>docker<span class=w> </span>ps
</pre></div></table></div><ul><li>List all containers (running, created, exited, ...).</ul><div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span><span class=gp>user@host$ </span>docker<span class=w> </span>ps<span class=w> </span>-a
</pre></div></table></div><ul><li>Filter container list (say status=exited).</ul><div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span><span class=gp>user@host$ </span>docker<span class=w> </span>ps<span class=w> </span>-a<span class=w> </span>-f<span class=w> </span><span class=s2>"status=exited"</span>
</pre></div></table></div><ul><li>Get container logs.</ul><div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span><span class=gp>user@host$ </span>docker<span class=w> </span>logs<span class=w> </span><span class=s2>"</span><span class=nv>$container_name</span><span class=s2>"</span>
</pre></div></table></div><ul><li>Get more information on the container.</ul><div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span><span class=gp>user@host$ </span>docker<span class=w> </span>container<span class=w> </span>inspect<span class=w> </span><span class=s2>"</span><span class=nv>$container_name</span><span class=s2>"</span>
</pre></div></table></div><h2>Images inspection.</h2><ul><li>List all docker images.</ul><div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span><span class=gp>user@host$ </span>docker<span class=w> </span>images
</pre></div></table></div><ul><li>Get more information on the image.</ul><div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span><span class=gp>user@host$ </span>docker<span class=w> </span>image<span class=w> </span>inspect<span class=w> </span><span class=s2>"</span><span class=nv>$image_name</span><span class=s2>"</span>:<span class=s2>"</span><span class=nv>$image_tag</span><span class=s2>"</span>
</pre></div></table></div><h2>Format output into JSON.</h2><ul><li>Get names of exited container.</ul><div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span><span class=gp>user@host$ </span>docker<span class=w> </span>ps<span class=w> </span>-a<span class=w> </span>-f<span class=w> </span><span class=s2>"status=exited"</span><span class=w> </span>--format<span class=w> </span><span class=s2>"{{json .Names}}"</span>
</pre></div></table></div><h1>Live Debugging.</h1><p>Once information is gathered, we may need to tweak the container or live-debug. Most of these cases may require us to get a shell on the docker. The method of getting a shell may differ based on weather docker is running or docker has exited.<h2>Docker is running.</h2><ul><li>Exec into the shell (bash or sh or other shell).</ul><div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span><span class=gp>user@host$ </span>docker<span class=w> </span><span class=nb>exec</span><span class=w> </span>-it<span class=w> </span><span class=s2>"</span><span class=nv>$container_name</span><span class=s2>"</span><span class=w> </span>/bin/sh
</pre></div></table></div><ul><li>Run command <code>ls ./</code>.</ul><div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span><span class=gp>user@host$ </span>docker<span class=w> </span><span class=nb>exec</span><span class=w> </span>-t<span class=w> </span><span class=s2>"</span><span class=nv>$container_name</span><span class=s2>"</span><span class=w> </span>ls<span class=w> </span>./
</pre></div></table></div><h2>Docker has exited.</h2><ul><li>Get image, tag pair for exited container.</ul><div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span><span class=gp>user@host$ </span>docker<span class=w> </span>ps<span class=w> </span>-f<span class=w> </span><span class=s2>"name=</span><span class=nv>$container_name</span><span class=s2>"</span><span class=w> </span>--format<span class=w> </span><span class=s2>"{{json .Image}}"</span>
</pre></div></table></div><ul><li>Run image to get shell.</ul><div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span><span class=gp>user@host$ </span>docker<span class=w> </span>run<span class=w> </span>-it<span class=w> </span>--entrypoint<span class=w> </span>sh<span class=w> </span><span class=s2>"</span><span class=nv>$image_name</span><span class=s2>"</span>:<span class=s2>"</span><span class=nv>$image_tag</span><span class=s2>"</span>
</pre></div></table></div><ul><li>Run command <code>ls ./</code>.</ul><div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span><span class=gp>user@host$ </span>docker<span class=w> </span>run<span class=w> </span>-it<span class=w> </span>--entrypoint<span class=w> </span>ls<span class=w> </span><span class=s2>"</span><span class=nv>$image_name</span><span class=s2>"</span>:<span class=s2>"</span><span class=nv>$image_tag</span><span class=s2>"</span><span class=w> </span>./
</pre></div></table></div><h1>Post Debugging.</h1><p>After figuring out the issue, You may want to patch the environment or rollback and also do some basic cleanup. Rollback would be to tag previous tag to latest. In case previous tag is not available (as it is first deployment) or the version has some specific changes which cannot be reverted and patch release may take time, then docker needs to be patched.<h2>Rollback.</h2><ul><li>Tag latest to previous version</ul><div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span><span class=gp>user@host$ </span>docker<span class=w> </span>tag<span class=w> </span><span class=s2>"</span><span class=nv>$image_name</span><span class=s2>"</span>:<span class=s2>"</span><span class=nv>$image_previous_tag</span><span class=s2>"</span><span class=w> </span><span class=s2>"</span><span class=nv>$image_name</span><span class=s2>"</span>:latest
</pre></div></table></div><h2>Patch.</h2><p>Patching depends on the method used for debugging. In case of running container you can just commit it. For exited container which was run using custom entry point, entry point is overwritten. So the patching required to revert the entry point.<h3>Docker was exec-ed.</h3><ul><li>Commit the live-debugging container.</ul><div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span><span class=gp>user@host$ </span>docker<span class=w> </span>container<span class=w> </span>commit<span class=w> </span><span class=s2>"</span><span class=nv>$container_name</span><span class=s2>"</span><span class=w> </span><span class=s2>"</span><span class=nv>$image_name</span><span class=s2>"</span>:<span class=s2>"</span><span class=nv>$image_tag</span><span class=s2>"</span>-patched
</pre></div></table></div><ul><li>Kill the live-debugging container</ul><div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span><span class=gp>user@host$ </span>docker<span class=w> </span>container<span class=w> </span><span class=nb>kill</span><span class=w> </span><span class=s2>"</span><span class=nv>$container_name</span><span class=s2>"</span>
</pre></div></table></div><ul><li>Tag the patched version to latest.</ul><div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span><span class=gp>user@host$ </span>docker<span class=w> </span>tag<span class=w> </span><span class=s2>"</span><span class=nv>$image_name</span><span class=s2>"</span>:<span class=s2>"</span><span class=nv>$image_tag</span><span class=s2>"</span>-patched<span class=w> </span><span class=s2>"</span><span class=nv>$image_name</span><span class=s2>"</span>:latest
</pre></div></table></div><ul><li>Bring the latest service docker up.</ul><h3>Docker was exec-ed (entry point has changed).</h3><ul><li>Find the old entry point</ul><div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span><span class=gp>user@host$ </span>docker<span class=w> </span>image<span class=w> </span>inspect<span class=w> </span><span class=s2>"</span><span class=nv>$image_name</span><span class=s2>"</span>:<span class=s2>"</span><span class=nv>$image_tag</span><span class=s2>"</span><span class=w> </span>--format<span class=w> </span><span class=s2>"Entrypoint {{json .Config.Entrypoint}}"</span>
</pre></div></table></div><ul><li>Find the old cmd</ul><div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span><span class=gp>user@host$ </span>docker<span class=w> </span>image<span class=w> </span>inspect<span class=w> </span><span class=s2>"</span><span class=nv>$image_name</span><span class=s2>"</span>:<span class=s2>"</span><span class=nv>$image_tag</span><span class=s2>"</span><span class=w> </span>--format<span class=w> </span><span class=s2>"CMD {{json .Config.Cmd}}"</span>
</pre></div></table></div><ul><li>Commit the docker with the old entry point and cmd</ul><div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span><span class=gp>user@host$ </span>docker<span class=w> </span>container<span class=w> </span>commit<span class=w> </span>-change<span class=o>=</span><span class=s2>"</span><span class=nv>$old_entrypoint</span><span class=s2>"</span><span class=w> </span>--change<span class=o>=</span><span class=s2>"</span><span class=nv>$old_cmd</span><span class=s2>"</span><span class=w> </span><span class=s2>"</span><span class=nv>$container_name</span><span class=s2>"</span><span class=w> </span><span class=s2>"</span><span class=nv>$image_name</span><span class=s2>"</span>:<span class=s2>"</span><span class=nv>$image_tag</span><span class=s2>"</span>-patched
</pre></div></table></div><ul><li>Kill the live-debugging container</ul><div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span><span class=gp>user@host$ </span>docker<span class=w> </span>container<span class=w> </span><span class=nb>kill</span><span class=w> </span><span class=s2>"</span><span class=nv>$container_name</span><span class=s2>"</span>
</pre></div></table></div><ul><li>Tag the patched version to latest.</ul><div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span><span class=gp>user@host$ </span>docker<span class=w> </span>tag<span class=w> </span><span class=s2>"</span><span class=nv>$image_name</span><span class=s2>"</span>:<span class=s2>"</span><span class=nv>$image_tag</span><span class=s2>"</span>-patched<span class=w> </span><span class=s2>"</span><span class=nv>$image_name</span><span class=s2>"</span>:latest
</pre></div></table></div><ul><li>Bring the latest service docker up.</ul><h1>Cleaning up.</h1><ul><li>Delete exited container. You can use -q instead of --format flag part for getting only ids.</ul><div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span><span class=gp>user@host$ </span>docker<span class=w> </span>ps<span class=w> </span>-a<span class=w> </span>-f<span class=w> </span><span class=s2>"status=exited"</span><span class=w> </span>--format<span class=w> </span><span class=s2>"{{json .Names}}"</span><span class=w> </span><span class=p>|</span><span class=w> </span>xargs<span class=w> </span>-r<span class=w> </span>docker<span class=w> </span>rm
</pre></div></table></div><ul><li>Delete untagged images.</ul><div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span><span class=gp>user@host$ </span>docker<span class=w> </span>images<span class=w> </span>prune
</pre></div></table></div><h1>Tips.</h1><ul><li>Using <code>-q</code> for quiet mode on command provides only image ids or container ids.<li>Using <code>docker cp</code> can help in file transfer to and from container. - <code>docker cp  "$container_name":"$container_file_path" "local_file_path"</code> -> from container. - <code>docker cp  "local_file_path" "$container_name":"$container_file_path"</code> -> to container.</ul><h1>Resources.</h1><ul><li><a href=https://docs.docker.com/engine/reference/commandline/ps/><code>docker ps</code></a><li><a href=https://docs.docker.com/engine/reference/commandline/images/><code>docker images</code></a><li><a href=https://docs.docker.com/engine/reference/commandline/image_inspect/><code>docker image inspect</code></a><li><a href=https://docs.docker.com/engine/reference/commandline/container_inspect/><code>docker container inspect</code></a><li><a href=https://docs.docker.com/engine/reference/commandline/logs/><code>docker logs</code></a><li><a href=https://docs.docker.com/engine/reference/commandline/container_exec/><code>docker container exec</code></a><li><a href=https://docs.docker.com/engine/reference/commandline/run/><code>docker run</code></a><li><a href=https://docs.docker.com/engine/reference/commandline/container_commit/><code>docker container commit</code></a><li><a href=https://docs.docker.com/engine/reference/commandline/image_prune/><code>docker image prune</code></a><li><a href=https://docs.docker.com/config/formatting/><code>--format</code></a><li><a href=https://docs.docker.com/engine/reference/commandline/cp/><code>docker cp</code></a></ul></article></div><div class=tags><span>Post Tags:</span><a href=tag/patching.html>Â #patching,</a><a href=tag/debugging.html>Â #debugging,</a><a href=tag/docker.html>Â #docker</a></div><hr class=my-3><div id=comments></div><script>var PopulateComment=(a=>{let e=`div`,f=`a`,g=`item`;commentsBlock=document.getElementById(`comments`);let b=document.createElement(e);b.innerText=`Comments`;commentsBlock.append(b);let c=document.createElement(e);commentsBlock.append(c);a.forEach(a=>{let b=document.createElement(`span`);b.innerText=a.user.login;updateTime=document.createElement(`small`);updateTime.innerText=`(`+ a.updated_at+ `)`;commentBody=document.createElement(e);commentBody.innerText=a.body;lineBreak=document.createElement(`br`);commentBox=document.createElement(f);commentBox.classList.add(g);commentBox.append(b);commentBox.append(updateTime);commentBox.append(lineBreak);commentBox.append(commentBody);commentBox.href=a.html_url;c.append(commentBox)});let d=document.createElement(f);d.classList.add(g);d.href=issueUrl;d.innerText=`Have some comments? Add comment ...`;c.append(d)});let commentUrl=`https://api.github.com/repos/sak96/sak96.github.io/issues/3/comments`;let issueUrl=`https://github.com/sak96/sak96.github.io/issues/3`;var xhr=new XMLHttpRequest();xhr.open(`GET`,commentUrl,!0);xhr.responseType=`json`;xhr.onload=(()=>{var a=xhr.status;if(a===200){console.log(PopulateComment(xhr.response))}else{console.log(xhr.response)}});xhr.send()</script><script src=https://unpkg.com/mermaid@latest/dist/mermaid.min.js></script><hr><div class=footer><span>Powered by:</span><a href=http://getpelican.com/>Pelican,</a><a href=https://github.com/pygments/pygments>Pygments,</a><a href=https://github.com/morhetz/gruvbox-contrib>Gruvbox</a></div></div>