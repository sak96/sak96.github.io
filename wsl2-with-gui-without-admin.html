<!doctype html><title>WSL2 with GUI without Admin</title><link rel="shortcut icon" href=https://sak96.github.io/theme/images/favicon.svg><meta content=width=device-width,initial-scale=1.0 name=viewport><meta charset=UTF-8><link href=https://sak96.github.io/feeds/all.atom.xml rel=alternate title=sak96-blog type=application/atom+xml><link href=https://sak96.github.io/theme/syntax/pygment.css rel=stylesheet><style>*{box-sizing:border-box}:root{--bg:#1d2021;--fg:#d4be98;--gray:#928374;--blue:#7daea3;--green:#a9b665;--red:#ea6962}[data-theme=light]{--bg:#f9f5d7;--fg:#654735;--gray:#928374;--blue:#45707a;--green:#6c782e;--red:#c14a4a}table,th,td{border:1px solid var(--fg);border-collapse:collapse;padding:10px}.codehilitetable{border:2px solid var(--blue);border-collapse:collapse;border-radius:4px;padding:0;font-family:monospace;display:block;overflow-x:auto}.codehilite{margin:0 1em}.linenos{text-align:right;border:0;border-right:2px solid var(--blue);-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-khtml-user-select:none;padding:0 .5em}.code{border:0}body{background-color:var(--bg);color:var(--fg)}a{color:var(--blue);text-decoration:none}h1,h2,h3,h4,h5,h6{color:var(--green)}small{color:var(--gray)}.navbar{border-bottom:1px solid var(--green)}.navbar div{display:inline-block}.nav-end{position:absolute;right:.5rem}.navbar a{padding:.5rem 0}.navbar a:before{content:"["}.navbar a:after{content:"]"}#theme{cursor:pointer}[data-theme=light] #theme:before{content:"[ðŸŒš:"}#theme:before{content:"[ðŸŒž:"}#navbar-toggler{display:none}.content{width:80%;max-width:50rem;margin:auto}article em,article strong{color:var(--red)}.not-found,.coming-soon{text-align:center;width:100%;display:block}.item{border-top:1px dashed var(--red);color:var(--fg);margin:.5rem 0;padding:1rem;display:block}.item>:first-child{margin-top:0}.img-fluid{width:100%}.paginator{justify-content:space-between;margin:.5rem;display:flex}.footer,.tags{justify-content:center;margin:.5rem;display:flex}.disabled{pointer-events:none;color:var(--gray)}@media only screen and (width<=500px){.navbar{border:none}.nav-header{border-bottom:.025rem solid var(--green)}.navbar div{display:block;position:static}#navbar-toggler{background-color:inherit;color:inherit;border:none;display:inline;position:absolute;right:1rem;transform:rotate(90deg)}.navbar a:after,.navbar a:before{content:""}.navbar a{border-bottom:.025rem solid var(--green);display:none}.nav-header a{border:none;display:inline-block}.navbar a.show{display:block}.content{width:100%}.footer{display:inline-block}.paginator span{display:none}[data-theme=light] #theme:before{content:"ðŸŒš:"}#theme:before{content:"ðŸŒž:"}}</style><body><div class=navbar><div class=nav-header><a href=https://sak96.github.io/index.html>sak96-blog</a><a id=navbar-toggler>|||</a></div><div class=nav-start><a href=https://sak96.github.io/authors.html>Authors</a><a href=https://sak96.github.io/categories.html>Categories</a><a href=https://sak96.github.io/tags.html>Tags</a></div><div class=nav-end><a href=https://sak96.github.io/feeds/all.atom.xml>Atom</a><a id=theme>Theme</a></div></div><script>document.querySelector(`#navbar-toggler`).onclick=(a=>{document.querySelectorAll(`.nav-start a,.nav-end a`).forEach(a=>a.classList.toggle(`show`))});{let d=`data-theme`,e=`dark`,c=`light`,b=`theme`;let a=localStorage.getItem(b);if(a===c||window.matchMedia(`(prefers-color-scheme: light)`).matches){document.documentElement.setAttribute(d,c);localStorage.setItem(b,c)}else{document.documentElement.setAttribute(d,e);localStorage.setItem(b,e)}}document.querySelector(`#theme`).onclick=(a=>{let b=`data-theme`,d=`light`,c=`theme`;if(document.documentElement.getAttribute(b)){document.documentElement.setAttribute(b,``);localStorage.setItem(c,`dark`)}else{document.documentElement.setAttribute(b,d);localStorage.setItem(c,d)}})</script><div class=content><div><h1>WSL2 with GUI without Admin</h1><h5><p>My experience setting up WSL2 along with problems and solutions</h5><h5>Read time: 5 min</h5><small>Written on October 14, 2020</small></div><div><article><p>WSL or windows subsystem for linux is way to use linux interface on windows machine. WSL2 comes with better support for filesystem and network for linux interface. Previous <a href=https://sak96.github.io/wsl1-with-xserver-without-admin.html>Article</a> describes wsl1 setup.<p>WSL2 solves the <a title="Ubuntu sleep" href=https://discourse.ubuntu.com/t/ubuntu-20-04-and-wsl-1/15291>sleep issue</a> in Ubuntu wsl with updated glibc. WSL2 comes with not only comes with pros but also it's own share of issues. For WSL2 using Ubuntu 20.04 seemed easy, keeping WSL1 Debian setup as my backup. This Article walk through various problem faced and solutions if found.<h2>VPN and MTU</h2><p>VPN MTU was less that the WSL2 eth0 network interface. This caused network connection to hang on large transfers, more detail <a title="MTU VPN issue" href=https://github.com/microsoft/WSL/issues/5068#issuecomment-683917384>here</a>.<p>The VPN MTU can be accessed using following command.<div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span>netsh<span class=w> </span>interface<span class=w> </span>ipv4<span class=w> </span>show<span class=w> </span>subinterface
</pre></div></table></div><p>Setting same mtu to eth0 can be done as follows.<div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span>ip<span class=w> </span>link<span class=w> </span><span class=nb>set</span><span class=w> </span>mtu<span class=w> </span><span class=si>${</span><span class=nv>mtu_vpn</span><span class=si>}</span><span class=w> </span>dev<span class=w> </span>eth0
</pre></div></table></div><p>Single line command will be as follows.<div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span><span class=nf>%bash</span><span class=o>%</span><span class=w> </span><span class=o>-</span><span class=n>c</span><span class=w> </span><span class=s>"sudo ip link set mtu $($(wslpath '%windir%\system32</span><span class=se>\n</span><span class=s>etsh.exe') interface ipv4 show subinterface | $(wslpath '%windir%\system32</span><span class=se>\f</span><span class=s>indstr.exe') /i vpn   | grep -i vpn | sed 's/^\s\+//g'|  cut -f 1 -d ' ') dev eth0"</span>
</pre></div></table></div><h2>Network and GUI</h2><p>Using <a title="Visual C++ X server" href=https://sourceforge.net/projects/vcxsrv/>vcXsrv</a> seemed a fair choice for Xserver to use GUI. WSL2 restricts on using windows Network (localhost) on WSL2. vcXsrv could no longer be assessed by WSL2 for displaying GUI. Admin was required to add firewall allow rule to allow such connection.<p>Solution was to use <code>socat</code> to connect from WSL2 to Windows as mentioned <a title="Socat WSL2 to Windows" href=https://github.com/microsoft/WSL/issues/4619#issuecomment-678652118>here</a>.<ol><li>Install socat in ubuntu using <code>apt</code>.<li>Download socat for window from <a title="Socat for windows" href=https://sourceforge.net/projects/unix-utils/files/socat/>here</a>.<li>Set Downloaded socat path in <code>%socat%</code> varrable and run below command in cmd.</ol><div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span>start<span class=w> </span><span class=s2>"socat"</span><span class=w> </span>/min<span class=w>  </span>ubuntu2004.exe<span class=w> </span>-c<span class=w> </span><span class=s2>"socat UNIX-LISTEN:/tmp/.X11-unix/X0,fork exec:\"</span><span class=k>$(</span>wslpath<span class=w> </span><span class=s1>'%socat%'</span><span class=k>)</span><span class=s2> - TCP\:localhost\:6000\""</span>
</pre></div></table></div><h2>Xserver to Xrdp</h2><p>The above solution was slow. The other solution was to use ssh tunnel or use Xrdp. Install Xrdp and running it was simple, but automating is a challenge to be done.<div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div><td class=code><div><pre><span></span><span class=c1># Installation Command</span>
sudo<span class=w> </span>apt<span class=w> </span>install<span class=w> </span>--no-install-recommends<span class=w> </span>xrdp<span class=w> </span>xrdp-xorg

<span class=c1># Starting Service (Yet to automate)</span>
service<span class=w> </span>xrdp<span class=w> </span>start
</pre></div></table></div><p><strong>EDIT</strong> Found a better way to use run start the service. You can open run menu from <code>Win+r</code>. Type <code>shell:startup</code> and press <code>enter</code>. Add a bat file to start xrdp at startup. Note: sleep is required other wise xrdp does not startup<div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span>wsl<span class=w> </span>sudo<span class=w> </span>service<span class=w> </span>xrdp<span class=w> </span>start<span class=p>;</span><span class=w> </span>sleep<span class=w> </span><span class=m>5</span>
</pre></div></table></div><p>Rdp using the ip address. More details <a title="Get Ip Address" href=https://stackoverflow.com/a/26694162>here</a>.<div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span>ip<span class=w> </span>-4<span class=w> </span>addr<span class=w> </span>show<span class=w> </span>eth0<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>-oP<span class=w> </span><span class=s1>'(?<=inet\s)\d+(\.\d+){3}'</span>
</pre></div></table></div><p><strong>EDIT</strong> Found a better way to use run the above command. I had rdp connection file from my last connection say <code>~/rdp.rdp</code>. The following command open rdp connection using the above file from wsl. You can add this to bat file or add alias to the same.<div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span>mstsc.exe<span class=w> </span>/v:<span class=k>$(</span>hostname<span class=w> </span>-I<span class=k>)</span><span class=w> </span><span class=k>$(</span>wslpath<span class=w> </span>-w<span class=w> </span>~/rdp.rdp<span class=k>)</span>
</pre></div></table></div><h2>Xrdp and Sound</h2><p>To use sound on Xrdp with pulseaudio, some libraries are required. Copying the library from <a title="Xrdp PulseAudio" href=https://github.com/DesktopECHO/xWSL>here</a> helped.<div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span></pre></div><td class=code><div><pre><span></span><span class=c1># adding libraries</span>
<span class=n>git</span><span class=w> </span><span class=n>clone</span><span class=w> </span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>github</span><span class=o>.</span><span class=n>com</span><span class=o>/</span><span class=n>DesktopECHO</span><span class=o>/</span><span class=n>xWSL</span>
<span class=n>sudo</span><span class=w> </span><span class=n>mv</span><span class=w> </span><span class=n>xWSL</span><span class=o>/</span><span class=n>dist</span><span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>lib</span><span class=o>/</span><span class=n>xrdp</span><span class=o>-</span><span class=n>pulseaudio</span><span class=o>-</span><span class=n>installer</span><span class=w> </span><span class=k>var</span><span class=o>/</span><span class=n>lib</span><span class=o>/</span>

<span class=c1># restarting pulseaudio</span>
<span class=n>pulseaudio</span><span class=w> </span><span class=o>-</span><span class=n>k</span>
<span class=n>pulseaudio</span><span class=w> </span><span class=o>-</span><span class=n>D</span>
</pre></div></table></div><h2>Teams and WSL2</h2><p>Teams is messaging platform by microsoft whose installation instruction are <a title="Ms Teams Install" href=https://docs.microsoft.com/en-us/microsoftteams/get-clients>here</a>. To get working in WSL2 required installation of couple of missing dependencies.<div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span></pre></div><td class=code><div><pre><span></span><span class=c1># install teams</span>
curl<span class=w> </span>https://packages.microsoft.com/keys/microsoft.asc<span class=w> </span><span class=p>|</span><span class=w> </span>sudo<span class=w> </span>apt-key<span class=w> </span>add<span class=w> </span>-
sudo<span class=w> </span>sh<span class=w> </span>-c<span class=w> </span><span class=s1>'echo "deb [arch=amd64] https://packages.microsoft.com/repos/ms-teams stable main" > /etc/apt/sources.list.d/teams.list'</span>
sudo<span class=w> </span>apt<span class=w> </span>update
sudo<span class=w> </span>apt<span class=w> </span>install<span class=w> </span>teams

<span class=c1># install missing dependencies</span>
sudo<span class=w> </span>apt<span class=w> </span>install<span class=w> </span>libsecret-1-0<span class=w> </span>chromium-codecs-ffmpeg
</pre></div></table></div><h2>Automating at Startup</h2><p>Setting mtu and booting up xrdp every time is annoying. For mtu setting least value of vpn and network works without trouble. Xrdp startup command needs a small sleep to ensure that command really worked.<p>To make this work open run menu by pressing <code>win</code> + <code>R</code>. Type <code>shell:startup</code> to open the startup folder. Add the following script in a file <code>wsl.bat</code> in the folder. Replace <code>$least_value</code> with least value of the mtu.<div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span>
<span class=normal>2</span></pre></div><td class=code><div><pre><span></span>wsl<span class=w> </span>sudo<span class=w> </span>ip<span class=w> </span>link<span class=w> </span><span class=nb>set</span><span class=w> </span>mtu<span class=w> </span><span class=nv>$least_value</span><span class=w> </span>dev<span class=w> </span>eth0<span class=p>;</span>
wsl<span class=w> </span>sudo<span class=w> </span>service<span class=w> </span>xrdp<span class=p>;</span><span class=w> </span>sleep<span class=w> </span><span class=m>5</span><span class=p>;</span>
</pre></div></table></div><p>Make following <code>rdp.bat</code> file in your desktop for faster launch of rdp. Double clicking on this file will start cmd program which launches rdp. The cmd prompt can be closed after some time.<div class=codehilite><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span class=normal>1</span></pre></div><td class=code><div><pre><span></span>wsl<span class=w> </span>mstsc.exe<span class=w> </span>/v:<span class=k>$(</span>hostname<span class=w> </span>-I<span class=k>)</span><span class=w> </span><span class=k>$(</span>wslpath<span class=w> </span>-w<span class=w> </span>~/rdp.rdp<span class=k>)</span>
</pre></div></table></div></article></div><div class=tags><span>Post Tags:</span><a href=tag/story.html>Â #story,</a><a href=tag/wsl.html>Â #wsl,</a><a href=tag/linux.html>Â #linux</a></div><hr class=my-3><div id=comments></div><script>var PopulateComment=(a=>{let e=`div`,f=`a`,g=`item`;commentsBlock=document.getElementById(`comments`);let b=document.createElement(e);b.innerText=`Comments`;commentsBlock.append(b);let c=document.createElement(e);commentsBlock.append(c);a.forEach(a=>{let b=document.createElement(`span`);b.innerText=a.user.login;updateTime=document.createElement(`small`);updateTime.innerText=`(`+ a.updated_at+ `)`;commentBody=document.createElement(e);commentBody.innerText=a.body;lineBreak=document.createElement(`br`);commentBox=document.createElement(f);commentBox.classList.add(g);commentBox.append(b);commentBox.append(updateTime);commentBox.append(lineBreak);commentBox.append(commentBody);commentBox.href=a.html_url;c.append(commentBox)});let d=document.createElement(f);d.classList.add(g);d.href=issueUrl;d.innerText=`Have some comments? Add comment ...`;c.append(d)});let commentUrl=`https://api.github.com/repos/sak96/sak96.github.io/issues/9/comments`;let issueUrl=`https://github.com/sak96/sak96.github.io/issues/9`;var xhr=new XMLHttpRequest();xhr.open(`GET`,commentUrl,!0);xhr.responseType=`json`;xhr.onload=(()=>{var a=xhr.status;if(a===200){console.log(PopulateComment(xhr.response))}else{console.log(xhr.response)}});xhr.send()</script><script src=https://unpkg.com/mermaid@latest/dist/mermaid.min.js></script><hr><div class=footer><span>Powered by:</span><a href=http://getpelican.com/>Pelican,</a><a href=https://github.com/pygments/pygments>Pygments,</a><a href=https://github.com/morhetz/gruvbox-contrib>Gruvbox</a></div></div>